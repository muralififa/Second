= Table.AddColumn(#"Filtered Rows", "InstanceName", each 
let 
    safe = [CAFSafeName], 
    file = [CAFFileName],

    // Choose delimiter based on safe name
    delimiter = 
        if Text.StartsWith(safe, "SVC-IH_MYSQL_") or 
           Text.StartsWith(safe, "SVC-IH_SYBASE_") or 
           Text.StartsWith(safe, "SVC-IH_POST") then "."
        else if Text.StartsWith(safe, "SVC-IH_ORA_") then "-"
        else null,

    // Clean Sybase file ending with 'v' or 'V'
    cleanedFile = 
        if Text.StartsWith(safe, "SVC-IH_SYBASE_") and Text.EndsWith(file, "v") then
            Text.Start(file, Text.Length(file) - 1)
        else if Text.StartsWith(safe, "SVC-IH_SYBASE_") and Text.EndsWith(file, "V") then
            Text.Start(file, Text.Length(file) - 1)
        else 
            file,

    // Extract instance name
    InstanceName = 
        if delimiter <> null and Text.Contains(cleanedFile, delimiter) then 
            Text.BeforeDelimiter(cleanedFile, delimiter) 
        else null

in 
    InstanceName
)