import pandas as pd
import pyodbc

# Path to your Excel
excel_file = "connection_hosts.xlsx"

driver = "{ODBC Driver 17 for SQL Server}"   # Make sure this driver is installed
default_db = "master"  # Fallback DB if none provided

# Load Excel
df = pd.read_excel(excel_file)

# Ensure Status column exists
if "Status" not in df.columns:
    df["Status"] = ""

# Iterate rows
for index, row in df.iterrows():
    host_port = str(row[0])  # First column has hostname/port
    
    if "/" in host_port:
        host, port = host_port.split("/")
    else:
        host = host_port
        port = "1433"  # Default SQL Server port

    # Build connection string (Trusted Connection, DB optional)
    conn_str = (
        f"DRIVER={driver};"
        f"SERVER={host},{port};"
        f"DATABASE={default_db};"
        "Trusted_Connection=yes;"
        "Encrypt=yes;TrustServerCertificate=no;Connection Timeout=5;"
    )

    try:
        conn = pyodbc.connect(conn_str)
        conn.close()
        df.at[index, "Status"] = "Connected"
    except Exception as e:
        df.at[index, "Status"] = "Not Connected"

# Save results
df.to_excel("connection_hosts_checked.xlsx", index=False)

print("âœ… Completed. Results saved in connection_hosts_checked.xlsx")